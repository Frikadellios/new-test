import Uploader from './editorjs-uploader.js';

const LOADER_DELAY = 500;
export default class HeaderLine {
	// constructor({ data, config, api, block }) {
	constructor(params) {
		this.api = params.api;

		this.nodes = {
			wrapper: null,
			wrapperParams: null,
			wrapperClass: null,
			titleClass: null,
			subTitleClass: null,
			asImage: false,

			title: null,
			subtitle: null,
			secureIcon: null,
		};

		this.config = {
			endpoint: params.config.endpoint || '',
			field: params.config.field || 'image',
			types: params.config.types || 'image/*',
			namePlaceholder: params.config.namePlaceholder || 'Name',
			descriptionPlaceholder: params.config.descriptionPlaceholder || 'Description',
			linkPlaceholder: params.config.linkPlaceholder || 'Link',
		};

		/**
		 * Set saved state
		 */
		this.data = params.data;

		this.config.uploader = params.config.uploader;
		this.uploader = new Uploader({
			config: this.config,
			getCurrentFile: () => this.data.secureIcon,
			onUpload: (response) => this.onUpload({ body: response }),
			onError: (error) => this.uploadingFailed(error),
		});

		this.onUpload = (response) => {
			const {
				body: { success, file },
			} = response;

			if (success && file && file.url) {
				this.data.secureIcon = file.url;

				this.showFullImage();
			}
			// super.onUpload(response);
			params.block.save().then((state) => {
				params.api.blocks.update(state.id, state.data);
			});
		};
	}

	onUpload(response) {
		const {
			body: { success, file },
		} = response;

		if (success && file && file.url) {
			this.data.secureIcon = file.url;

			this.showFullImage();
		}
	}

	static get toolbox() {
		return {
			title: 'Head Line',
			icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>`,
		};
	}

	render() {
		this.nodes.wrapper = this.make('div', 'HeadLine');
		this.nodes.wrapperClass = this.make('div', 'HeadLineWrapper');

		this.nodes.wrapperParams = this.make('div', 'HeadLineParams');

		const paramsWrapperClassWrp = this.make('div', 'HeadLineParams_inputWrapper');
		const paramsWrapperClassLabel = this.make(
			'label',
			'',
			{
				contentEditable: false,
				for: 'wrapperClass',
			},
			'Wrapper Class'
		);
		const paramsWrapperClassInput = this.make('input', '', {
			type: 'text',
			name: 'wrapperClass',
			value: this.data && this.data.wrapperClass ? this.data.wrapperClass : '',
		});

		const paramsTitleClassWrp = this.make('div', 'HeadLineParams_inputWrapper');
		const paramsTitleClassLabel = this.make(
			'label',
			'',
			{
				contentEditable: false,
				for: 'titleClass',
			},
			'Title Class'
		);
		const paramsTitleClassInput = this.make('input', '', {
			type: 'text',
			name: 'titleClass',
			value: this.data && this.data.titleClass ? this.data.titleClass : '',
		});

		const paramsSubTitleClassWrp = this.make('div', 'HeadLineParams_inputWrapper');
		const paramsSubTitleClassLabel = this.make(
			'label',
			'',
			{
				contentEditable: false,
				for: 'SubtitleClass',
			},
			'Sub Title Class'
		);
		const paramsSubTitleClassInput = this.make('input', '', {
			type: 'text',
			name: 'SubtitleClass',
			value: this.data && this.data.subTitleClass ? this.data.subTitleClass : '',
		});

		const paramsAsImgWrp = this.make('div', 'HeadLineParams_inputWrapper');
		const paramsAsImgLabel = this.make(
			'label',
			'',
			{
				contentEditable: false,
				for: 'asImg',
			},
			'Show as Image'
		);
		const paramsAsInput = this.make('input', '', {
			type: 'text',
			name: 'asImg',
			type: 'checkbox',
			checked: this.data.asImage ?? true,
			value: 'asImage',
		});

		// HEAD LINE
		const HeadLineWrapper = this.make('div', 'HeadLine_Wrapper');
		this.nodes.title = this.make(
			'div',
			'HeadLineTitle_inputWrapper',
			{
				contentEditable: true,
			},
			this.data && this.data.title ? this.data.title : 'SECURE USPS© CHANGE OF ADDRESS©'
		);
		this.nodes.subtitle = this.make(
			'div',
			'HeadLine_inputWrapper',
			{
				contentEditable: true,
			},
			this.data && this.data.subtitle ? this.data.subtitle : 'SECURE FORM'
		);

		const logoplaceholder =
			'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJ/SURBVDjLbVJBaxNBGH2bpEkTmxi1NTRKTZtoQUHEWz0Igj2I4kG9eVNQhEBO7bEHc+yv8JAiHnr2B4gFqVrQRhObljQolBSTJqZJdnZmfbNr2rU68DEz33zfm/fejGHbNrxjaWlpRCk1J6WcYZxkgPGTsWJZ1mIul/vlrTe8AIVC4Qqbl5PJ5GQsFoPP5wP36PV6qNfr2OIg0L35+fm1fwDYPMLDj+l0OmOaJmq1Gjqdjr4dgUAAiUTCqSsWixvMXV5YWOjqvW+AxOSz8fHxjBAC5XJ5s91up7gO6tDrUqn0QwOTXYZSsoO+wGDB5EwkEkGlUgGb7mSz2apHajWfz9+sVqvFVCrl1P4PYExr5m16vYUjQ+c0O11DtmN/ebD95pG9UpnGzl7Y0Xz30ir8toAtLdiWG0JIvFi76piaGG7g9plVTD/5YLgMCPLg/g0YtMTwhznfApRBfsP6kAYJSKuN57Md5oXTsvHy7aEEfZMutHZfIRAahWGMsHAICMeZVsD+HmTrG8zudyhrH+HJLGyz7wEgRSh9k4nm+nvqPIb4xWuovV5k/2lMXJ9F8+s6ARqIpk6QsIQtTC+AcGTYpBqfvgBfcJTuKMi+xKfdMCZgIp6eRK8TYu2+w2oA4PwDm+5qVK218XmNLN7xxILqKfS7pGqTWekLmuVtV65STs8hA73RqJQQP5+CP3KKACamHj7FlGBDawfH00kEW0MuA8o9AmA6qMrSHqwTIAoM08hAkHkN0ES3UYfotBGdiNFu5cr2AmgJobOPET7nhxEMuU/o40soSjO7iHbbVNgnUen6pY0/AOCTbC7PuV44H0f8Cetg5g9zP5aU7loDcfwGcrKyzYdvwUUAAAAASUVORK5CYII=';

		this.nodes.secureIcon = this.make('img', this.CSS.secureIcon, {
			src: this.data && this.data.secureIcon ? this.data.secureIcon : logoplaceholder,
		});

		paramsWrapperClassWrp.appendChild(paramsWrapperClassLabel);
		paramsWrapperClassWrp.appendChild(paramsWrapperClassInput);

		paramsTitleClassWrp.appendChild(paramsTitleClassLabel);
		paramsTitleClassWrp.appendChild(paramsTitleClassInput);

		paramsSubTitleClassWrp.appendChild(paramsSubTitleClassLabel);
		paramsSubTitleClassWrp.appendChild(paramsSubTitleClassInput);

		paramsAsImgLabel.prepend(paramsAsInput);
		paramsAsImgWrp.appendChild(paramsAsImgLabel);

		this.nodes.wrapperParams.appendChild(paramsWrapperClassWrp);
		this.nodes.wrapperParams.appendChild(paramsTitleClassWrp);
		this.nodes.wrapperParams.appendChild(paramsSubTitleClassWrp);
		this.nodes.wrapperParams.appendChild(paramsAsImgWrp);

		this.nodes.wrapperClass.appendChild(this.nodes.title);
		this.nodes.subtitle.prepend(this.nodes.secureIcon);
		this.nodes.wrapperClass.appendChild(this.nodes.subtitle);

		this.nodes.wrapper.appendChild(this.nodes.wrapperClass);
		this.nodes.wrapper.appendChild(this.nodes.wrapperParams);

		this.nodes.secureIcon.addEventListener('click', () => {
			this.uploader.uploadSelectedFile({
				onPreview: () => {
					this.addLoader();
				},
			});
		});

		if (this.data.secureIcon) {
			this.setFullImageSource(this.data.secureIcon);
		}

		return this.nodes.wrapper;
	}
	// save(blockContent) {
	// 	return {
	// 		url: blockContent.value,
	// 	};
	// }
	setFullImageSource(image) {
		const imageUrlWithToken = this.uploader.config.uploader.addTokenToURL(image) + '';
		//	this.nodes.secureIcon.style.background = `url('${imageUrlWithToken}') center center / cover no-repeat`;
		this.nodes.secureIcon.src = imageUrlWithToken;
	}

	showFullImage() {
		setTimeout(() => {
			this.nodes.secureIcon.classList.remove(this.CSS.loader);
			this.setFullImageSource(this.data.secureIcon);
		}, LOADER_DELAY);
	}

	save(toolsContent) {
		// const name = toolsContent.querySelector(`.${this.CSS.name}`).textContent;
		// const description = toolsContent.querySelector(`.${this.CSS.description}`).textContent;
		// const link = toolsContent.querySelector(`.${this.CSS.link}`).textContent;
		const secureIcon = this.data.secureIcon;
		const wrapperClass = toolsContent.querySelector('[name="wrapperClass"]').value;
		const titleClass = toolsContent.querySelector('[name="titleClass"]').value;
		const subTitleClass = toolsContent.querySelector('[name="SubtitleClass"]').value;
		const asImage = toolsContent.querySelector('[name="asImg"]').checked;

		const title = toolsContent.querySelector('.HeadLineTitle_inputWrapper').textContent;
		const subtitle = toolsContent.querySelector('.HeadLine_inputWrapper').textContent;

		/**
		 * Fill missing fields with empty strings
		 */

		Object.assign(this.data, {
			wrapperClass: wrapperClass.trim() || '',
			titleClass: titleClass.trim() || '',
			subTitleClass: subTitleClass.trim() || '',
			asImage: asImage || false,
			title: title.trim() || '',
			subtitle: subtitle.trim() || '',
		});
		return this.data;
	}

	stopLoading() {
		setTimeout(() => {
			this.nodes.secureIcon.classList.remove(this.CSS.loader);
			this.nodes.secureIcon.removeAttribute('style');
		}, LOADER_DELAY);
	}

	/**
	 * Show loader when file upload started
	 */
	addLoader() {
		this.nodes.secureIcon.style.background = 'none';
		this.nodes.secureIcon.classList.add(this.CSS.loader);
	}

	/**
	 * If file uploading failed, remove loader and show notification
	 * @param {string} errorMessage -  error message
	 */
	uploadingFailed(errorMessage) {
		this.stopLoading();

		this.api.notifier.show({
			message: errorMessage,
			style: 'error',
		});
	}

	get CSS() {
		return {
			baseClass: this.api.styles.block,
			input: this.api.styles.input,
			loader: this.api.styles.loader,

			/**
			 * Tool's classes
			 */
			wrapperClass: 'cdx-component-HeadLine-WrapperClass',
			wrapperParams: 'cdx-headerParams',
			wrapperHeader: 'cdx-header',
			headerClass: 'cdx-headerParams__headerClass',
			headerWrapperClass: 'cdx-headerParams__WrapperClass',
			showPhone: 'cdx-headerParams__showPhone',
			phoneAsImage: 'cdx-headerParams__phoneAsImage',

			phone: 'cdx-header__phone',
			secureIcon: 'cdx-header__secureIcon',
			name: 'cdx-header__name',
		};
	}

	validate(savedData) {
		/**
		 * Return false if fields are empty
		 */
		return (
			savedData.wrapperClass ||
			savedData.titleClass ||
			savedData.subTitleClass ||
			savedData.asImage ||
			savedData.title ||
			savedData.subtitle
		);
	}

	make(tagName, classNames = null, attributes = {}, content = '') {
		const el = document.createElement(tagName);

		if (Array.isArray(classNames)) {
			el.classList.add(...classNames);
		} else if (classNames) {
			el.classList.add(classNames);
		}

		for (const attrName in attributes) {
			el[attrName] = attributes[attrName];
		}
		if (content !== '') {
			el.innerHTML = content;
		}

		return el;
	}

	renderSettings() {
		const settings = [
			{
				name: 'Custom Configuration',
				title: 'Custom Configuration',
				type: 'showConfig',
				prop: { showSettings: true },
				icon: `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="20" height="20" rx="5" fill="white"/>
				<path d="M10 6.25V5M10 6.25C9.66848 6.25 9.35054 6.3817 9.11612 6.61612C8.8817 6.85054 8.75 7.16848 8.75 7.5C8.75 7.83152 8.8817 8.14946 9.11612 8.38388C9.35054 8.6183 9.66848 8.75 10 8.75M10 6.25C10.3315 6.25 10.6495 6.3817 10.8839 6.61612C11.1183 6.85054 11.25 7.16848 11.25 7.5C11.25 7.83152 11.1183 8.14946 10.8839 8.38388C10.6495 8.6183 10.3315 8.75 10 8.75M6.25 13.75C6.58152 13.75 6.89946 13.6183 7.13388 13.3839C7.3683 13.1495 7.5 12.8315 7.5 12.5C7.5 12.1685 7.3683 11.8505 7.13388 11.6161C6.89946 11.3817 6.58152 11.25 6.25 11.25M6.25 13.75C5.91848 13.75 5.60054 13.6183 5.36612 13.3839C5.1317 13.1495 5 12.8315 5 12.5C5 12.1685 5.1317 11.8505 5.36612 11.6161C5.60054 11.3817 5.91848 11.25 6.25 11.25M6.25 13.75V15M6.25 11.25V5M10 8.75V15M13.75 13.75C14.0815 13.75 14.3995 13.6183 14.6339 13.3839C14.8683 13.1495 15 12.8315 15 12.5C15 12.1685 14.8683 11.8505 14.6339 11.6161C14.3995 11.3817 14.0815 11.25 13.75 11.25M13.75 13.75C13.4185 13.75 13.1005 13.6183 12.8661 13.3839C12.6317 13.1495 12.5 12.8315 12.5 12.5C12.5 12.1685 12.6317 11.8505 12.8661 11.6161C13.1005 11.3817 13.4185 11.25 13.75 11.25M13.75 13.75V15M13.75 11.25V5" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>												
				`,
			},
		];

		const wrapper = document.createElement('div');
		const wrapperAdditional = document.createElement('div');

		// const wrapper_header = document.createElement('div');
		// wrapper_header.classList.add('cdx-settings-button-header-wrapper');

		settings.forEach((tune) => {
			let button = document.createElement('div');

			button.classList.add('cdx-settings-button');
			button.setAttribute('title', tune.title);
			button.innerHTML = tune.icon;
			wrapperAdditional.appendChild(button);

			button.addEventListener('click', () => {
				this._toggleTune(tune.type, tune.prop);
				if (tune.type == 'showConfig') {
					for (var item of document.querySelectorAll('.cdx-settings-button--active-headerLineContainerSettings')) {
						item.classList.remove('cdx-settings-button--active-headerLineContainerSettings');
					}
					button.classList.toggle('cdx-settings-button--active-headerLineContainerSettings');
				}
			});
		});

		wrapper.appendChild(wrapperAdditional);

		return wrapper;
	}

	_toggleTune(tune, props) {
		if (tune == 'showConfig') {
			this.nodes.wrapper.querySelector('.HeadLineParams').classList.toggle('active');
		}
	}
}
