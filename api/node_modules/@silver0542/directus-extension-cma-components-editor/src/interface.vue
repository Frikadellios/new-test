<template>
	<div :ref="uid" :class="{ [font]: true, disabled, bordered }"></div>

	<v-drawer
		v-if="haveFilesAccessS() && !disabled"
		:model-value="fileHandler !== null"
		icon="image"
		:title="translate('upload_from_device')"
		:cancelable="true"
		@update:model-value="unsetFileHandler"
		@cancel="unsetFileHandler"
	>
		<div class="uploader-drawer-content">
			<div v-if="currentPreview" class="uploader-preview-image">
				<img :src="currentPreview" />
			</div>
			<v-upload
				ref="uploaderComponentElement"
				:multiple="false"
				:folder="folder"
				from-library
				from-url
				@input="handleFile"
			/>
		</div>
	</v-drawer>
</template>

<script>
import './index.css';
import './custom-plugins/wyswyg/styleEditor.css';

import { v4 as uuidv4 } from 'uuid';
import EditorJS from '@editorjs/editorjs';
import HeaderNew from './custom-plugins/plugin-headernew-old.js';
import HeaderLine from './custom-plugins/plugin-headLine.js';
import PersonalityTool from './custom-plugins/plugin-personality-patch.js';
import * as useDirectusToken from './directus-token.js';
import * as useFileHandler from './filehandler.js';
import { useApi, useStores } from '@directus/extensions-sdk';
import { useI18n } from 'vue-i18n';
import cloneDeep from 'lodash/cloneDeep';
import RawToolTool from '@editorjs/raw';
// import CodeTool from '@editorjs/code';
import editorjsColumns from './custom-plugins/plugin-cols.js';
import FormCols from './custom-plugins/plugin-formCols.js';
import CheckoutCols from './custom-plugins/plugin-checkoutCols.js';
import FormColTitle from './custom-plugins/plugin-formColTitle.js';
import isEqual from 'lodash/isEqual';

import AlignmentTuneTool from 'editorjs-text-alignment-blocktune';
import TextColorTune from './custom-plugins/tune-text-color.js';
import containerBgTune from './custom-plugins/tune-background.js';
import containerTypeTune from './custom-plugins/tune-container.js';
import textStyleTune from './custom-plugins/tune-textStyle.js';
import PaddingTune from './custom-plugins/tune-padding.js';
import MarginTune from './custom-plugins/tune-margin.js';
import EditorJsContainer from './custom-plugins/plugin_container.js';
import OrderDetails from './custom-plugins/plugin-orderDetails.js';
import BillingAddress from './custom-plugins/plugin_bilingaddress.js';
import CreditCardClass from './custom-plugins/plugin_creditCard.js';
import BillingDetailsClass from './custom-plugins/plugin_bilingDetails.js';
import AgreementCheckBox from './custom-plugins/plugin_agreementCheckbox.js';
import SubmitButton from './custom-plugins/plugin_checkoutSubmit.js';

import Paragraph from '@editorjs/paragraph';
import Delimiter from '@editorjs/delimiter';
import Header from '@editorjs/header';
import Alert from 'editorjs-alert';
import ImageTool from './custom-plugins/plugin-image-patch.js';
import MoveDuration from './custom-plugins/plugin-moveDuration.js';
import MoveType from './custom-plugins/plugin-moveType.js';
import PersonalInfo from './custom-plugins/plugin_personalnfo.js';
import OldAddress from './custom-plugins/plugin_oldAddress.js';
import NewAddress from './custom-plugins/plugin_newAddress.js';
import Packages from './custom-plugins/plugin_packages.js';
import OrderSummary from './custom-plugins/plugin_orderSummary.js';

import textLine from './custom-plugins/plugin_textLine.js';
import SubmitButtonHome from './custom-plugins/plugin_formSubmit.js';
import AgreementCheckBoxHome from './custom-plugins/plugin_agreementCheckboxHome.js';
import ContactForm from './custom-plugins/plugin_contactForm.js';
import SupportForm from './custom-plugins/plugin_supportForm.js';

// FlowBite
import FlowBiteHeroOne from './custom-plugins/flowbite/flowbite-hero1.js';
import FlowBiteHeroSecond from './custom-plugins/flowbite/flowbite-hero2.js';

export default {
	props: {
		disabled: { type: Boolean, default: false },
		nullable: { type: Boolean, default: false },
		autofocus: { type: Boolean, default: false },
		value: { type: Object, default: null },
		bordered: { type: Boolean, default: true },
		placeholder: { type: String, default: '' },
		tools: {
			type: Array | String,
			default: [
				'headerNew',
				'myComponent',
				'raw',
				'header',
				'nestedlist',
				'code',
				'image',
				'paragraph',
				'delimiter',
				'checklist',
				'quote',
				'underline',
			],
		},
		folder: { type: String, default: '' },
		font: { type: String, default: 'sans-serif' },
	},
	emits: ['input'],
	watch: {
		value: async function (newVal, oldVal) {
			console.log('WATCH ----->Value', newVal, oldVal);
			if (!this.editorjsInstance.value || !this.editorjsInstance.value.isReady || this.isInternalChange) return;

			// Do not render if there is uploader active operation.
			if (this.fileHandler && this.fileHandler.value !== null) return;

			if (isEqual(newVal.blocks, oldVal.blocks)) return;
			console.log(this.editorjsInstance.value);
			try {
				await this.editorjsInstance.value.isReady;
				const value = this.getSanitizedValue(newVal);
				if (value) {
					await this.editorjsInstance.value.render(value);
				} else {
					this.editorjsInstance.value.clear();
				}
			} catch (error) {
				window.console.warn('editorjs-extension: %s', error);
			}

			this.isInternalChange = false;
		},
		props: {
			deep: true,
			async handler(newVal, oldVal) {
				console.log('WATCH ----->', newVal, oldVal);
			},
		},
		// value: async function(newVal, oldVal){
		'editorjsInstance.value': {
			deep: false,
			immediate: true,
			handler(newVal, oldVal) {
				console.log('WATCH ----->', newVal, oldVal);
			},
		},
		// editorjsInstance: async function(newVal, oldVal) {
		// 	 console.log('WATCH ----->', newVal, oldVal)
		// 	if (!this.editorjsInstance.value || !this.editorjsInstance.value.isReady || this.isInternalChange.value) return;

		// 	// Do not render if there is uploader active operation.
		// 	if (this.fileHandler && this.fileHandler.value !== null) return;

		// 	if (isEqual(newVal.blocks, oldVal.blocks)) return;

		// 	try {
		// 		await this.editorjsInstance.value.isReady;
		// 		const value = this.getSanitizedValue(newVal);
		// 		if (value) {
		// 			await this.editorjsInstance.value.render(value);
		// 		} else {
		// 			this.editorjsInstance.value.clear();
		// 		}
		// 	} catch (error) {
		// 		window.console.warn('editorjs-extension: %s', error);
		// 	}

		// 	this.isInternalChange = false;
		// }
	},
	setup(props, { emit }) {
		return { handleChange };
		function handleChange(value) {
			console.log('VALUE =>>>', value);
			emit('input', value);
		}
	},
	data() {
		return {
			uid: uuidv4(),
			isInternalChange: false,
			// uploaderComponentElement: '',
			fileHandler: null,
			// haveFilesAccess: false,
			unsetFileHandler: null,
			currentPreview: null,
			handleFile: null,
			editorjsInstance: {},
		};
	},
	mounted() {
		// console.log(this.value);
		// console.log('PROPS:', this.$props);
		// console.log(useApi);
		// console.log(this.translate('upload_from_device'))

		this.convertedFunc();
		const { useCollectionsStore } = useStores();
		const collectionStore = useCollectionsStore();
		const { currentPreview, fileHandler, unsetFileHandler, handleFile } = useFileHandler.default;
		this.unsetFileHandler = unsetFileHandler;
		this.currentPreview = currentPreview;
		this.handleFile = handleFile;
		this.fileHandler = fileHandler;

		// this.haveFilesAccess = Boolean(collectionStore.getCollection('directus_files'));
		// console.log('AA:', useFileHandler, currentPreview,fileHandler,unsetFileHandler,handleFile);
	},
	methods: {
		getSanitizedValue(value) {
			if (!value || typeof value !== 'object' || !value.blocks || value.blocks.length < 1) return null;

			return cloneDeep({
				time: value.time || Date.now(),
				version: value.version || '0.0.0',
				blocks: value.blocks,
			});
		},
		haveFilesAccessS() {
			const { useCollectionsStore } = useStores();
			const collectionStore = useCollectionsStore();
			// console.log('collectionStore', useCollectionsStore, collectionStore.getCollection('directus_files'));
			// return false
			return Boolean(collectionStore.getCollection('directus_files'));
		},
		translate(e) {
			const { t } = useI18n();
			return t(e);
		},
		createUpladConfig() {
			// const { t } = useI18n;
			let _self = this;
			const api = useApi();
			const { addTokenToURL } = useDirectusToken.default(api);
			const { setCurrentPreview, setFileHandler } = useFileHandler.default;
			// console.log(_self.$refs);
			const uploaderConfig = {
				addTokenToURL,
				baseURL: api.defaults.baseURL,
				setFileHandler,
				setCurrentPreview,
				getUploadFieldElement: () => _self.$refs.uploaderComponentElement,
				t: {
					no_file_selected: this.translate('no_file_selected'),
				},
			};
			return uploaderConfig;
		},
		getTools() {
			let uploaderConfig = this.createUpladConfig();
			let column_tools = {
				headerText: {
					class: Header,
					tunes: ['alignmentTune', 'texColorTune', 'paddings', 'margins'],
					inlineToolbar: true,
				},
				contactForm: {
					class: ContactForm,
				},
				supportForm: {
					class: SupportForm,
				},
				alert: Alert,
				raw: RawToolTool,
				// paragraph : editorjsParagraphLinebreakable,
				delimiter: Delimiter,
				paragraph: {
					class: Paragraph,
					inlineToolbar: true,
					tunes: ['alignmentTune', 'textStyleTune', 'texColorTune', 'paddings', 'margins'],
				},
				imageComponent: {
					class: ImageTool,
					config: {
						uploader: uploaderConfig,
					},
				},
				alignmentTune: {
					class: AlignmentTuneTool,
					config: {
						default: 'left',
						blocks: {
							header: 'center',
							list: 'right',
						},
					},
				},
				textStyleTune: {
					class: textStyleTune,
				},
				texColorTune: {
					class: TextColorTune,
				},
				paddings: {
					class: PaddingTune,
				},
				margins: {
					class: MarginTune,
				},
			};
			let container_toosl = {
				...column_tools,
				columns: {
					class: editorjsColumns,
					// tunes: ['alignmentTune'],
					config: {
						tools: column_tools,
						tunes: ['alignmentTune'],
						// IMPORTANT! ref the column_tools
					},
				},
			};
			let tunes = {
				alignmentTune: {
					class: AlignmentTuneTool,
					config: {
						default: 'left',
						blocks: {
							header: 'center',
							list: 'right',
						},
					},
				},

				texColorTune: {
					class: TextColorTune,
				},
				backgroundTune: {
					class: containerBgTune,
				},
				containerTune: {
					class: containerTypeTune,
				},
				textStyleTune: {
					class: textStyleTune,
				},
				paddings: {
					class: PaddingTune,
				},
				margins: {
					class: MarginTune,
				},
			};
			let defVals = {
				textLine: {
					class: textLine,
					inlineToolbar: true,
					tunes: [
						'alignmentTune',
						'texColorTune',
						'textStyleTune',
						'backgroundTune',
						'containerTune',
						'paddings',
						'margins',
					],
				},
				contactForm: {
					class: ContactForm,
				},
				supportForm: {
					class: SupportForm,
				},
				headerNew: {
					class: HeaderNew,
					inlineToolbar: true,
					tunes: ['texColorTune', 'backgroundTune', 'containerTune'],
					config: {
						uploader: uploaderConfig,
					},
				},
				headLine: {
					class: HeaderLine,
					inlineToolbar: true,
					tunes: ['texColorTune', 'backgroundTune', 'containerTune', 'paddings', 'margins'],
					config: {
						uploader: uploaderConfig,
					},
				},
				packages: {
					class: Packages,
				},
				formCols: {
					class: FormCols,
					inlineToolbar: true,
					config: {
						tools: {
							moveDuration: {
								class: MoveDuration,
							},
							personalInformation: {
								class: PersonalInfo,
							},
							oldAddress: {
								class: OldAddress,
							},
							newAddress: {
								class: NewAddress,
							},
							moveType: {
								class: MoveType,
							},
							agreementCheckBoxHome: {
								inlineToolbar: true,
								class: AgreementCheckBoxHome,
								tunes: ['texColorTune', 'textStyleTune'],
							},
							submitButtonHome: {
								class: SubmitButtonHome,
								tunes: ['backgroundTune', 'texColorTune', 'alignmentTune', 'textStyleTune', 'paddings', 'margins'],
							},
							headerText: {
								class: Header,
								tunes: ['alignmentTune', 'textStyleTune'],
							},
							raw: RawToolTool,
							imageComponent: {
								class: ImageTool,
								config: {
									uploader: uploaderConfig,
								},
							},
							subCols: {
								class: editorjsColumns,
								// tunes: ['alignmentTune'],
								config: {
									tools: {
										moveDuration: {
											class: MoveDuration,
										},
										personalInformation: {
											class: PersonalInfo,
										},
										oldAddress: {
											class: OldAddress,
										},
										newAddress: {
											class: NewAddress,
										},
										moveType: {
											class: MoveType,
										},
										headerText: {
											class: Header,
											tunes: ['alignmentTune', 'textStyleTune'],
										},
										raw: RawToolTool,
										imageComponent: {
											class: ImageTool,
											config: {
												uploader: uploaderConfig,
											},
										},
										columns: {
											class: editorjsColumns,
											// tunes: ['alignmentTune'],
											config: {
												tools: column_tools,
												tunes: ['alignmentTune'],
												// IMPORTANT! ref the column_tools
											},
										},
										texColorTune: {
											class: TextColorTune,
										},
										backgroundTune: {
											class: containerBgTune,
										},
										paragraph: {
											class: Paragraph,
											inlineToolbar: false,
											tunes: ['alignmentTune', 'texColorTune', 'textStyleTune', 'paddings', 'margins'],
										},
										alignmentTune: {
											class: AlignmentTuneTool,
											config: {
												default: 'left',
												blocks: {
													header: 'center',
													list: 'right',
												},
											},
										},
										formColTitle: {
											class: FormColTitle,
											tunes: ['texColorTune', 'backgroundTune', 'alignmentTune'],
										},
										agreementCheckBoxHome: {
											inlineToolbar: true,
											class: AgreementCheckBoxHome,
											tunes: ['texColorTune', 'textStyleTune'],
										},
										submitButtonHome: {
											class: SubmitButtonHome,
											tunes: [
												'backgroundTune',
												'texColorTune',
												'alignmentTune',
												'textStyleTune',
												'paddings',
												'margins',
											],
										},
										textStyleTune: {
											class: textStyleTune,
										},
										paddings: {
											class: PaddingTune,
										},
										margins: {
											class: MarginTune,
										},
									},
									tunes: ['alignmentTune'],
									// IMPORTANT! ref the column_tools
								},
							},
							texColorTune: {
								class: TextColorTune,
							},
							backgroundTune: {
								class: containerBgTune,
							},
							paragraph: {
								class: Paragraph,
								inlineToolbar: false,
								tunes: ['alignmentTune', 'texColorTune', 'textStyleTune', 'paddings', 'margins'],
							},
							alignmentTune: {
								class: AlignmentTuneTool,
								config: {
									default: 'left',
									blocks: {
										header: 'center',
										list: 'right',
									},
								},
							},
							formColTitle: {
								class: FormColTitle,
								tunes: ['texColorTune', 'backgroundTune', 'alignmentTune'],
							},
							textStyleTune: {
								class: textStyleTune,
							},
							paddings: {
								class: PaddingTune,
							},
							margins: {
								class: MarginTune,
							},
						},
						tunes: ['formColTitle'],
						// IMPORTANT! ref the column_tools
					},
					tunes: ['backgroundTune', 'paddings', 'margins'],
				},
				checkoutForm: {
					class: CheckoutCols,
					inlineToolbar: true,
					config: {
						tools: {
							orderDetails: {
								class: OrderDetails,
							},
							orderSummary: {
								class: OrderSummary,
							},
							bilingAddress: {
								class: BillingAddress,
							},
							creditCard: {
								class: CreditCardClass,
							},
							billingDetails: {
								class: BillingDetailsClass,
							},
							agreementCheckBox: {
								inlineToolbar: true,
								class: AgreementCheckBox,
								tunes: ['texColorTune', 'textStyleTune'],
							},
							submitButton: {
								class: SubmitButton,
								tunes: ['backgroundTune', 'texColorTune', 'alignmentTune', 'textStyleTune', 'paddings', 'margins'],
							},
							headerText: {
								class: Header,
								tunes: ['alignmentTune', 'textStyleTune'],
							},
							raw: RawToolTool,
							imageComponent: {
								class: ImageTool,
								config: {
									uploader: uploaderConfig,
								},
							},
							subCols: {
								class: editorjsColumns,
								// tunes: ['alignmentTune'],
								config: {
									tools: {
										headerText: {
											class: Header,
											tunes: ['alignmentTune', 'textStyleTune'],
										},
										raw: RawToolTool,
										imageComponent: {
											class: ImageTool,
											config: {
												uploader: uploaderConfig,
											},
										},
										columns: {
											class: editorjsColumns,
											// tunes: ['alignmentTune'],
											config: {
												tools: column_tools,
												tunes: ['alignmentTune'],
												// IMPORTANT! ref the column_tools
											},
										},
										texColorTune: {
											class: TextColorTune,
										},
										backgroundTune: {
											class: containerBgTune,
										},
										paragraph: {
											class: Paragraph,
											inlineToolbar: false,
											tunes: ['alignmentTune', 'texColorTune', 'textStyleTune', 'paddings', 'margins'],
										},
										alignmentTune: {
											class: AlignmentTuneTool,
											config: {
												default: 'left',
												blocks: {
													header: 'center',
													list: 'right',
												},
											},
										},
										formColTitle: {
											class: FormColTitle,
											tunes: ['texColorTune', 'backgroundTune', 'alignmentTune'],
										},
										textStyleTune: {
											class: textStyleTune,
										},
										paddings: {
											class: PaddingTune,
										},
										margins: {
											class: MarginTune,
										},
									},
									tunes: ['alignmentTune'],
									// IMPORTANT! ref the column_tools
								},
							},
							texColorTune: {
								class: TextColorTune,
							},
							backgroundTune: {
								class: containerBgTune,
							},
							paragraph: {
								class: Paragraph,
								inlineToolbar: false,
								tunes: ['alignmentTune', 'texColorTune', 'textStyleTune', 'paddings', 'margins'],
							},
							alignmentTune: {
								class: AlignmentTuneTool,
								config: {
									default: 'left',
									blocks: {
										header: 'center',
										list: 'right',
									},
								},
							},
							formColTitle: {
								class: FormColTitle,
								tunes: ['texColorTune', 'backgroundTune', 'alignmentTune'],
							},
							textStyleTune: {
								class: textStyleTune,
							},
							paddings: {
								class: PaddingTune,
							},
							margins: {
								class: MarginTune,
							},
						},
						tunes: ['formColTitle'],
					},
					tunes: ['backgroundTune', 'paddings', 'margins'],
				},
				flowBite_HeroOne: {
					class: FlowBiteHeroOne,
					tunes: ['backgroundTune'],
					inlineToolbar: true,
					config: {
						uploader: uploaderConfig,
					},
				},
				flowBite_HeroSecond: {
					class: FlowBiteHeroSecond,
					tunes: ['backgroundTune'],
					inlineToolbar: true,
					config: {
						uploader: uploaderConfig,
					},
				},
				raw: {
					class: RawToolTool,
				},
				columns: {
					class: editorjsColumns,
					// tunes: ['alignmentTune'],
					config: {
						tools: column_tools,
						tunes: ['alignmentTune'],
						// IMPORTANT! ref the column_tools
					},
				},
				imageComponent: {
					class: ImageTool,
					config: {
						uploader: uploaderConfig,
					},
				},
				headerText: {
					class: Header,
					inlineToolbar: true,
					tunes: ['alignmentTune', 'texColorTune'],
				},
				paragraph: {
					class: Paragraph,
					inlineToolbar: true,
					tunes: ['alignmentTune', 'texColorTune'],
				},
				container: {
					class: EditorJsContainer,
					config: {
						tools: container_toosl,
						// IMPORTANT! ref the column_tools
					},
					tunes: ['texColorTune', 'backgroundTune', 'containerTune', 'paddings', 'margins'],
				},
			};
			let tools = {};

			for (const toolName of this.tools) {
				// if (!haveFilesAccess && fileRequiresTools.includes(toolName)) continue;

				if (toolName in defVals) {
					tools[toolName] = defVals[toolName];
				}
			}
			tools = { ...tools, ...tunes };
			// console.log('enabled TOOLS', tools);
			return tools;
		},
		convertedFunc() {
			let _self = this;
			//let addTokenToURL = useDirectusToken(api);
			let tls = this.getTools();
			// window.editor = new EditorJS({
			this.editorjsInstance.value = new EditorJS({
				// i18n: getTranslations(t),
				// logLevel: 'ERROR' as EditorJS.LogLevels,
				holder: this.$refs[this.uid],
				data: this.value || undefined,
				// Readonly makes troubles in some cases, also requires all plugins to implement it.
				// https://github.com/codex-team/editor.js/issues/1669
				readOnly: false,
				placeholder: this.placeholder,
				minHeight: 72,
				onReady: function (e) {
					console.log('ready', e);
				},
				// save: (outputData) => {console.log('SAVE->', outputData)},
				onChange: (a, b) => _self.emitValue(a, b),
				// tools: this.tools,
				tools: tls,
			});

			console.log('REFS', this.$refs);
			// EditorJS
		},
		async emitValue(context, event) {
			// console.log('Context', context);
			if (this.disabled || !context || !context.saver) return;
			this.isInternalChange = true;

			try {
				// Fixes deleting multiple blocks bug https://github.com/codex-team/editor.js/issues/1755#issuecomment-929550729
				await this.wait(200);
				const result = await context.saver.save();

				if (!result || result.blocks.length < 1) {
					this.$emit('input', this.nullable ? null : '{}');
					return;
				}

				if (isEqual(result.blocks, this.value.blocks)) return;
				this.$emit('input', result);
			} catch (error) {
				window.console.warn('editorjs-extension: %s', error);
			}
		},
		async wait(ms) {
			return new Promise((resolve) => setTimeout(resolve, ms));
		},
	},
};
</script>

<style lang="css" scoped>
.disabled {
	color: var(--foreground-subdued);
	background-color: var(--background-subdued);
	border-color: var(--border-normal);
	pointer-events: none;
}

.bordered {
	padding: var(--input-padding) 4px var(--input-padding) calc(var(--input-padding) + 8px) !important;
	background-color: var(--background-page);
	border: var(--border-width) solid var(--border-normal);
	border-radius: var(--border-radius);
}

.bordered:hover {
	border-color: var(--border-normal-alt);
}

.bordered:focus-within {
	border-color: var(--primary);
}

.monospace {
	font-family: var(--family-monospace);
}

.serif {
	font-family: var(--family-serif);
}

.sans-serif {
	font-family: var(--family-sans-serif);
}

.uploader-drawer-content {
	padding: var(--content-padding);
	padding-top: 0;
	padding-bottom: var(--content-padding);
}

.uploader-preview-image {
	margin-bottom: var(--form-vertical-gap);
	background-color: var(--background-normal);
	border-radius: var(--border-radius);
}

.uploader-preview-image img {
	display: block;
	width: auto;
	max-width: 100%;
	height: auto;
	max-height: 40vh;
	margin: 0 auto;
	object-fit: contain;
}
</style>

<style src="./editorjs-ui.css"></style>
<style src="./editorjs-components.css"></style>
<style src="./editorjs-content-reset.css"></style>
